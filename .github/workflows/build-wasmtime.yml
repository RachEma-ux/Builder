name: Build Wasmtime for Android

on:
  workflow_dispatch:
    inputs:
      wasmtime_version:
        description: 'Wasmtime version (e.g., v15.0.0)'
        required: true
        default: 'v15.0.0'

env:
  ANDROID_API_LEVEL: 26

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: aarch64-linux-android
            abi: arm64-v8a
          - target: x86_64-linux-android
            abi: x86_64

    steps:
      - name: Checkout Builder
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3
        with:
          packages: 'ndk;25.2.9519653'

      - name: Set NDK environment
        run: |
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Clone Wasmtime
        run: |
          git clone --depth 1 --branch ${{ github.event.inputs.wasmtime_version }} \
            https://github.com/bytecodealliance/wasmtime.git /tmp/wasmtime

      - name: Build Wasmtime for ${{ matrix.abi }}
        run: |
          cd /tmp/wasmtime
          cargo ndk \
            --target ${{ matrix.target }} \
            --platform ${{ env.ANDROID_API_LEVEL }} \
            build \
            --release \
            --manifest-path crates/c-api/Cargo.toml

      - name: Strip debug symbols
        run: |
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
            /tmp/wasmtime/target/${{ matrix.target }}/release/libwasmtime.so

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/${{ matrix.abi }}
          cp /tmp/wasmtime/target/${{ matrix.target }}/release/libwasmtime.so \
             artifacts/${{ matrix.abi }}/
          ls -lh artifacts/${{ matrix.abi }}/

      - name: Upload library
        uses: actions/upload-artifact@v4
        with:
          name: wasmtime-${{ matrix.abi }}
          path: artifacts/${{ matrix.abi }}/libwasmtime.so
          retention-days: 90

  package:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Builder
        uses: actions/checkout@v4

      - name: Clone Wasmtime for headers
        run: |
          git clone --depth 1 --branch ${{ github.event.inputs.wasmtime_version }} \
            https://github.com/bytecodealliance/wasmtime.git /tmp/wasmtime

      - name: Download ARM64 library
        uses: actions/download-artifact@v4
        with:
          name: wasmtime-arm64-v8a
          path: package/libs/arm64-v8a

      - name: Download x86_64 library
        uses: actions/download-artifact@v4
        with:
          name: wasmtime-x86_64
          path: package/libs/x86_64

      - name: Copy headers
        run: |
          mkdir -p package/include
          cp /tmp/wasmtime/crates/c-api/include/wasmtime.h package/include/
          cp /tmp/wasmtime/crates/c-api/include/wasm.h package/include/
          # Copy wasmtime subdirectory headers if they exist
          if [ -d "/tmp/wasmtime/crates/c-api/include/wasmtime" ]; then
            cp -r /tmp/wasmtime/crates/c-api/include/wasmtime package/include/
          fi

      - name: Create version info
        run: |
          cat > package/WASMTIME_VERSION << EOF
          Wasmtime Version: ${{ github.event.inputs.wasmtime_version }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Android API Level: ${{ env.ANDROID_API_LEVEL }}
          Architectures: arm64-v8a, x86_64
          Build Run: ${{ github.run_id }}
          EOF

      - name: List package contents
        run: |
          echo "=== Package Contents ==="
          find package -type f -exec ls -lh {} \;

      - name: Upload complete package
        uses: actions/upload-artifact@v4
        with:
          name: wasmtime-android-${{ github.event.inputs.wasmtime_version }}
          path: package/
          retention-days: 90

      - name: Summary
        run: |
          echo "## Wasmtime Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.wasmtime_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**API Level:** ${{ env.ANDROID_API_LEVEL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Libraries" >> $GITHUB_STEP_SUMMARY
          echo "| ABI | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|" >> $GITHUB_STEP_SUMMARY
          echo "| arm64-v8a | $(ls -lh package/libs/arm64-v8a/libwasmtime.so | awk '{print $5}') |" >> $GITHUB_STEP_SUMMARY
          echo "| x86_64 | $(ls -lh package/libs/x86_64/libwasmtime.so | awk '{print $5}') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`wasmtime-android-${{ github.event.inputs.wasmtime_version }}\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract to \`native/wasmtime-android/\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Rebuild the app: \`./gradlew assembleDebug\`" >> $GITHUB_STEP_SUMMARY
