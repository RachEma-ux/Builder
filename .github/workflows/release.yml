name: Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version name (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build-release:
    name: Build Release APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept licenses
        run: yes | sdkmanager --licenses || true

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update version in build.gradle.kts
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_CODE=$(echo "$VERSION" | sed 's/\.//g' | sed 's/^0*//')

          sed -i "s/versionCode = [0-9]*/versionCode = $VERSION_CODE/" app/build.gradle.kts
          sed -i "s/versionName = \".*\"/versionName = \"$VERSION\"/" app/build.gradle.kts

          echo "Updated version to $VERSION (code: $VERSION_CODE)"
          grep -E "versionCode|versionName" app/build.gradle.kts

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Rename APK
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mv app/build/outputs/apk/release/app-release.apk app/build/outputs/apk/release/Builder-v${VERSION}.apk

          # Generate checksum
          cd app/build/outputs/apk/release
          sha256sum Builder-v${VERSION}.apk > Builder-v${VERSION}.apk.sha256
          cat Builder-v${VERSION}.apk.sha256

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: Builder-v${{ steps.version.outputs.version }}
          path: |
            app/build/outputs/apk/release/Builder-v*.apk
            app/build/outputs/apk/release/Builder-v*.apk.sha256
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            app/build/outputs/apk/release/Builder-v*.apk
            app/build/outputs/apk/release/Builder-v*.apk.sha256
          generate_release_notes: true
          body: |
            ## Builder v${{ steps.version.outputs.version }}

            ### Installation
            1. Download `Builder-v${{ steps.version.outputs.version }}.apk`
            2. Enable "Install from unknown sources" in Android settings
            3. Open the APK file to install

            ### Features
            - WASM pack management and execution
            - GitHub integration for pack discovery
            - Secure sandboxed runtime environment

            ### Requirements
            - Android 8.0 (API 26) or higher
            - ARM64 or x86_64 device
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APK_SIZE=$(ls -lh app/build/outputs/apk/release/Builder-v${VERSION}.apk | awk '{print $5}')

          echo "## Release Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### APK Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Size:** $APK_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** Builder-v${VERSION}.apk" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checksum" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat app/build/outputs/apk/release/Builder-v${VERSION}.apk.sha256 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
